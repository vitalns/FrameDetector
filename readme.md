# FrameDetector

Консольное приложение для обработки и анализа изображений с возможностью подключения к видеокамере через
Ethernet интерфейс и отправкой результатов обработки через UART интерфейс.

Для запуска приложения набрать в CMD в папке проекта команду:
```cmd
python frame_detector.py
        --rtsp-url rtsp://192.168.1.100:554 ^
        --uart-port COM3 ^
        --baudrate 921600 ^
        --bytesize 8 ^
        --parity odd ^
        --stopbits 1 ^
        --mavlink-version 2 ^
        --message-id 250
```
Заданные в примере параметры подключения используются по умолчанию.

## Основной функционал:
- Подключение к камере, захват и чтение видео;
- Анализ каждого кадра: размер, насыщенность, наличие чисто белого и чисто черного цветов, дата и время кадра
 с точностью до миллисекунд
(Результаты записываются в CSV-файл в директории frame_data\frame_attributes\contours_time_stamp.csv,
к имени каждого файла добавляется временная метка с точностью до миллисекунд);
- Выделение контуров на кадре и распозноавние объектов с помощью модели CNN (модель обучена на распознование 3 классов: круг, квадрат, треугольник);
- Определение количество контуров, координаты центра и размер в пикселяхт(ширина и высота) каждого контура
(Результаты записываются в CSV-файл в директории frame_data\detector_results\contours_time_stamp.csv,
к имени каждого файла добавляется временная метка с точностью до миллисекунд);
- Отправка координат центров, ширину и высоту контуров по UART с использованием протокола Mavlink 2.0.

## Дерево проекта:
1. **frame_detector** - главный исполняемый скрипт, результаты обработки и анализа кадров сохраняются в корне проекта в папке *frames_data*.
2. **test_frame_detector** - скрипт для подключения по Ethernet с возможностью
переключения на синтетические данные для тестирования алгоритмов обработки и анализа кадров,
выводит привью сгенерированного видео и обработанных кадров. Сгенерированное видео
*test_video.avi* сохраняется в корневой папке. Для запуска через CMD
нужно ввести команду:
```cmd
python test_frame_detector.py --ip 192.168.1.100 --port 554
```
3. Пакет **video_analyser** включает два модуля **frame_analyzer** и **shape_classifier**.
      3.1. Модуль **frame_analyzer** содержит три основных метода:
    3.1.1. **get_frame_attributes** используется для получения информации о кадре (размер, насыщенность, наличие чисто белого и
чисто черного цветов, дата время кадра);
    3.1.2. **edge_detection** используется для поиска объектов и выделения контуров объектов на кадре;
    3.1.3. **process_contours** используется для определения координат центров, ширины, высоты, площади контуров,
а также их распознования.
    3.2. Модуль **shape_classifier** включает один основной метод **classify_shape**, который используется для классификации контруров
по трём классам (круг, квадрат, треугольник). Реализованна классификация формы контура с использованием геометрических характеристик, предсказаний модели CNN и гибридный метод, в котором сначало используется классификация с использванием геометрических характеристик, а затем нераспознанные контуры определяются с помощью модели CNN.
4. Папка cnn содержит скрипты для обучения модели CNN: data_generator для генерации обучающих данных,
train_cnn для обучения модели CNN, model_input_info для контроля входных данных модели (входной кадр в формате 
shape = (1, 128, 128, 1), dtype = float32, format = [0/1]). Также в этой папке хранится обученная модель model.h5,
графики сходимости при обучении training_convergence.png, а также визуализация первого бача
из обучающей и валидационной выборки (train_set и validation_set соответственно).
5. Пакет video_stream содержит скрипты для взаимодействия с внешним оборудованием через UART и Ethernet интерфейсы,
а также генератор синтетических данных для тестирования приложения.
- ethernet_client реализует подключение к камере по Ethernet (на вход принимает rtsp://192.168.1.100:554);
- ethernet_connection также реализует подключение к камере по Ethernet, но
дополнен методом переподключения и поддержкой контекстного менеджера;
- parse_rtsp может использоваться для парсинга командной строки и формирования протокола RTSP,
содержит декоратор класса @classmethod. Это вспомогательный метод в главном исполняемом скрипте парсинг CMD реализован
через функцию;
- uart_mavlink_client реализует подключение и отправку данных через интерфейс UART с использованием протокола Mavlink 2.0
- virtual_camera используется для создания синтетических данных, и имеет 4 основных метода: generate_frame_stream
(генерация потока кадров), generate_video (генерация видеофайла 'avi'), generate_random_frames (генерация случайных
кадров) и generate_cnn_data (генерация случайных кадров с предобработкой для обучений CNN).
6. Папка tests содержит скрипты по тестированию модулей frame_analyzer, virtual_camera и ethernet_connection.

